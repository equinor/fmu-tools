

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fmu.tools.rms.copy_rms_param_to_ertbox_grid &mdash; fmu-tools 1.19.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=f0c121d3"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            fmu-tools
              <img src="../../../../_static/equinor-logo2.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../readme.html">fmu-tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fmudesign.html">FMU design matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../qcforward.html">The qcforward functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../qcproperties.html">The qcproperties class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../qcreset.html">The qcreset module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generate_petro_jobs_for_field_update.html">rms.generate_petro_jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../properties.html">The properties package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../domain_conversion.html">Domain conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../create_rft_ertobs.html">create_rft_ertobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rename_rms_scripts.html">rms.rename_rms_scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rms_import_localmodule.html">rms.import_localmodule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generate_bw_per_facies.html">rms.create_bw_per_facies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../update_petro_real.html">rms.update_petro_parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../export_and_import_fields.html">rms.export_and_import_field_parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../copy_rms_param_to_ertbox_grid.html">rms.copy_rms_param</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../utilities.html">The fmu-tools utilities package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rmsvolumetrics2csv.html">rmsvolumetrics2csv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ensembles.html">Ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">API for fmu.tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">fmu-tools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fmu.tools.rms.copy_rms_param_to_ertbox_grid</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fmu.tools.rms.copy_rms_param_to_ertbox_grid</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module is used in FMU workflows to copy a continuous 3D parameter</span>
<span class="sd">from geomodel grid to ERTBOX grid and extrapolate values that are undefined</span>
<span class="sd">in ERTBOX grid. This functionality is used when the user wants to</span>
<span class="sd">use FIELD keywords for petrophysical properties in ERT in Assisted History Matching.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.ma</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ma</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fmu.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">ROXAR</span>

<span class="k">if</span> <span class="n">ROXAR</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">rmsapi</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rmsapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Direction</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">roxar</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rmsapi</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">roxar</span><span class="w"> </span><span class="kn">import</span> <span class="n">Direction</span>


<span class="k">else</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">DEBUG_OFF</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DEBUG_ON</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEBUG_VERBOSE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">DEBUG_VERY_VERBOSE</span> <span class="o">=</span> <span class="mi">3</span>


<div class="viewcode-block" id="copy_rms_param">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.copy_rms_param">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">copy_rms_param</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copy 3D RMS parameters between geogrid to ERTBOX grid and optionally</span>
<span class="sd">    extrapolate and fill all ERTBOX grid cells.</span>
<span class="sd">    Specify input as dictionary with all input.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: Add an example from Drogon here in the doc string how it is used</span>
    <span class="c1">#       in RMS python job</span>

    <span class="c1"># Example of use in RMS:</span>

    <span class="c1"># NOTE: In the example below the geo grid has 3 zones.</span>
    <span class="c1">#       Ertbox grid has always 1 zone.</span>
    <span class="c1">#       The parameter names for geogrid is the same for each zone</span>
    <span class="c1">#       since it is a multizone grid and zone number + parameter name</span>
    <span class="c1">#       uniquely identify the field parameter.</span>
    <span class="c1">#       The key (integer numbers) in the two dicts refer to zone number</span>
    <span class="c1">#       in geogrid, so for zone number 1 the Zone1_Perm and Zone1_Poro</span>
    <span class="c1">#       values in the Ertbox grid corresponds to the Perm and Poro values</span>
    <span class="c1">#       for zone number 1 in the geogrid.</span>
    <span class="c1">#</span>
    <span class="c1">#       When copying from geo to Ertbox grid there can be grid cells in Ertbox</span>
    <span class="c1">#       that does not correspond to any active grid cell value in the geo grid.</span>
    <span class="c1">#       To fill in some values for those grid cells, an extrapolation method</span>
    <span class="c1">#       is used. The reason for extrapolating is to avoid having undefined</span>
    <span class="c1">#       values in Ertbox since all cell values are used in ERT when updating</span>
    <span class="c1">#       field values. It is an advantage to avoid unrealistic values in ERT</span>
    <span class="c1">#       ensemble vector due to the calculation of updated (analysis step in ERT)</span>
    <span class="c1">#       ensemble vectors to avoid making linear combinations of values for grid</span>
    <span class="c1">#       cells that may correspond to active grid cell in geogrid in</span>
    <span class="c1">#       one realization, but not for another realisation due to 3D grids varying</span>
    <span class="c1">#       from realisation to realisation.</span>
    <span class="c1">#</span>
    <span class="c1">#       When copying from Ertbox grid to geo grid, all grid cells in specified</span>
    <span class="c1">#       zones in the geo grid</span>
    <span class="c1">#       will correspond to a value in the Ertbox grid.</span>
    <span class="c1">#</span>
    <span class="c1"># This example copies from geogrid to ertbox grid:</span>

    <span class="c1"># from fmu.tools.rms import copy_rms_param</span>

    <span class="c1"># params ={</span>
    <span class="c1">#     &quot;project&quot;: project,</span>
    <span class="c1">#     &quot;debug_level&quot;: DEBUG_OFF,</span>
    <span class="c1">#     &quot;Mode&quot;: &quot;from_geo_to_ertbox&quot;,</span>
    <span class="c1">#     &quot;GeoGridParameters&quot;: {</span>
    <span class="c1">#         1: [&quot;Perm&quot;, &quot;Poro&quot;],</span>
    <span class="c1">#         2: [&quot;Perm&quot;, &quot;Poro&quot;],</span>
    <span class="c1">#         3: [&quot;Perm&quot;, &quot;Poro&quot;],</span>
    <span class="c1">#     },</span>
    <span class="c1">#     &quot;ErtboxParameters&quot;: {</span>
    <span class="c1">#         1: [&quot;Zone1_Perm&quot;, &quot;Zone1_Poro&quot;],</span>
    <span class="c1">#         2: [&quot;Zone2_Perm&quot;, &quot;Zone2_Poro&quot;],</span>
    <span class="c1">#         3: [&quot;Zone3_Perm&quot;, &quot;Zone3_Poro&quot;],</span>
    <span class="c1">#     },</span>
    <span class="c1">#     &quot;Conformity&quot;: {</span>
    <span class="c1">#         1: &quot;TopConform&quot;,</span>
    <span class="c1">#         2: &quot;Proportional&quot;,</span>
    <span class="c1">#         3: &quot;BaseConform&quot;,</span>
    <span class="c1">#     },</span>

    <span class="c1">#     &quot;GridModelName&quot;: &quot;Geogrid&quot;,</span>
    <span class="c1">#     &quot;ZoneParam&quot;: &quot;Zone&quot;,</span>
    <span class="c1">#     &quot;ERTBoxGridName&quot;: &quot;ERTBOX&quot;,</span>
    <span class="c1">#     &quot;ExtrapolationMethod&quot;: &quot;repeat&quot;,</span>
    <span class="c1">#     &quot;SaveActiveParam&quot;: True,</span>
    <span class="c1">#     &quot;AddNoiseToInactive&quot;: True,</span>
    <span class="c1"># }</span>
    <span class="c1"># copy_rms_param(params)</span>

    <span class="c1"># This example copies from ertbox grid to geogrid:</span>

    <span class="c1"># from fmu.tools.rms import copy_rms_param</span>

    <span class="c1"># params ={</span>
    <span class="c1">#     &quot;project&quot;: project,</span>
    <span class="c1">#     &quot;debug_level&quot;: DEBUG_OFF,</span>
    <span class="c1">#     &quot;Mode&quot;: &quot;from_ertbox_to_geo&quot;,</span>
    <span class="c1">#     &quot;GeoGridParameters&quot;: {</span>
    <span class="c1">#         1: [&quot;Perm&quot;, &quot;Poro&quot;],</span>
    <span class="c1">#         2: [&quot;Perm&quot;, &quot;Poro&quot;],</span>
    <span class="c1">#         3: [&quot;Perm&quot;, &quot;Poro&quot;],</span>
    <span class="c1">#     },</span>
    <span class="c1">#     &quot;ErtboxParameters&quot;: {</span>
    <span class="c1">#         1: [&quot;Zone1_Perm&quot;, &quot;Zone1_Poro&quot;],</span>
    <span class="c1">#         2: [&quot;Zone2_Perm&quot;, &quot;Zone2_Poro&quot;],</span>
    <span class="c1">#         3: [&quot;Zone3_Perm&quot;, &quot;Zone3_Poro&quot;],</span>
    <span class="c1">#     },</span>
    <span class="c1">#     &quot;Conformity&quot;: {</span>
    <span class="c1">#         1: &quot;TopConform&quot;,</span>
    <span class="c1">#         2: &quot;Proportional&quot;,</span>
    <span class="c1">#         3: &quot;BaseConform&quot;,</span>
    <span class="c1">#     },</span>

    <span class="c1">#     &quot;GridModelName&quot;: &quot;Geogrid&quot;,</span>
    <span class="c1">#     &quot;ZoneParam&quot;: &quot;Zone&quot;,</span>
    <span class="c1">#     &quot;ERTBoxGridName&quot;: &quot;ERTBOX&quot;,</span>
    <span class="c1"># }</span>
    <span class="c1"># copy_rms_param(params)</span>

    <span class="n">project</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>
    <span class="n">required_kw_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mode&quot;</span><span class="p">]</span>
    <span class="n">check_missing_keywords_list</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">required_kw_list</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;Mode&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;from_geo_to_ertbox&quot;</span><span class="p">:</span>
        <span class="c1"># The names of the parameters in ertbox is automatically set to</span>
        <span class="c1"># &lt;zone_name&gt;_&lt;param_name_from_geomodel&gt; since it follows</span>
        <span class="c1"># the standard used in APS and therefore no need to specify</span>
        <span class="c1"># parameter names in ertbox.</span>
        <span class="c1"># Check that necessary params are specified</span>
        <span class="n">required_kw_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;GridModelName&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ERTBoxGridName&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ZoneParam&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Conformity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SaveActiveParam&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ExtrapolationMethod&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GeoGridParameters&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">check_missing_keywords_list</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">required_kw_list</span><span class="p">)</span>
        <span class="n">from_geogrid_to_ertbox</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">project</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;from_ertbox_to_geo&quot;</span><span class="p">:</span>
        <span class="c1"># The name both in ertbox and in geogrid is required</span>
        <span class="c1"># here since no standard naming convention is required here.</span>
        <span class="c1"># Check that necessary params are specified</span>
        <span class="n">required_kw_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;GridModelName&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ERTBoxGridName&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ZoneParam&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Conformity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ErtboxParameters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GeoGridParameters&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">check_missing_keywords_list</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">required_kw_list</span><span class="p">)</span>
        <span class="n">from_ertbox_to_geogrid</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
            <span class="s2">&quot;Unknown value for keyword &#39;Mode&#39;. &quot;</span>
            <span class="s2">&quot;Legal values: &#39;from_geo_to_ertbox&#39; &quot;</span>
            <span class="s2">&quot;and &#39;from_ertbox_to_geo&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="check_missing_keywords_list">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.check_missing_keywords_list">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_missing_keywords_list</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">required_kw</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">missing_kw</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">required_kw</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">or</span> <span class="n">params</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">missing_kw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_kw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing specification of the keywords: </span><span class="si">{</span><span class="n">missing_kw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="from_geogrid_to_ertbox">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.from_geogrid_to_ertbox">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">from_geogrid_to_ertbox</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to copy a set of field parameters from geogrid to ertbox grid.</span>
<span class="sd">    A parameter in geogrid is copied to ertbox with name</span>
<span class="sd">    zone_name + &#39;_&#39; + petrovariablename.</span>
<span class="sd">    The input is a dictionary with specification of grid names, parameter names,</span>
<span class="sd">    grid layout (conformity).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Assign user specified parameters</span>
    <span class="n">grid_model_name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;GridModelName&quot;</span><span class="p">]</span>
    <span class="n">zone_param_name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ZoneParam&quot;</span><span class="p">]</span>
    <span class="n">ertbox_grid_model_name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ERTBoxGridName&quot;</span><span class="p">]</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ExtrapolationMethod&quot;</span><span class="p">,</span> <span class="s2">&quot;extend_layer_mean&quot;</span><span class="p">)</span>
    <span class="n">param_names_geogrid_dict</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;GeoGridParameters&quot;</span><span class="p">]</span>

    <span class="n">conformity_dict_input</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;Conformity&quot;</span><span class="p">]</span>
    <span class="n">debug_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;debug_level&quot;</span><span class="p">])</span>

    <span class="c1"># Optional parameter</span>
    <span class="n">save_active_param</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SaveActiveParam&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Optional parameter, Default is to add noise to inactive grid cell values</span>
    <span class="n">add_noise_to_inactive</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AddNoiseToInactive&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Check type and existence of geogrid parameters</span>
    <span class="p">(</span><span class="n">continuous_type_param_dict</span><span class="p">,</span> <span class="n">discrete_type_param_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">check_geogrid_parameters</span><span class="p">(</span>
        <span class="n">project</span><span class="p">,</span> <span class="n">grid_model_name</span><span class="p">,</span> <span class="n">param_names_geogrid_dict</span>
    <span class="p">)</span>

    <span class="c1"># Some conversion</span>
    <span class="n">conformity_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">znr</span><span class="p">,</span> <span class="n">conform_text</span> <span class="ow">in</span> <span class="n">conformity_dict_input</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">conformity_dict</span><span class="p">[</span><span class="n">znr</span><span class="p">]</span> <span class="o">=</span> <span class="n">conform_text</span>

    <span class="n">geogrid_model</span><span class="p">,</span> <span class="n">geogrid3D</span> <span class="o">=</span> <span class="n">get_grid_model</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">grid_model_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zone_param_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geogrid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The parameter </span><span class="si">{</span><span class="n">zone_param_name</span><span class="si">}</span><span class="s2"> does not exist in </span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2"> .&quot;</span>
        <span class="p">)</span>
    <span class="n">zone_param</span> <span class="o">=</span> <span class="n">geogrid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">zone_param_name</span><span class="p">]</span>
    <span class="n">zone_code_names</span> <span class="o">=</span> <span class="n">zone_param</span><span class="o">.</span><span class="n">code_names</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">ertboxgrid3D</span> <span class="o">=</span> <span class="n">get_grid_model</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">ertbox_grid_model_name</span><span class="p">)</span>

    <span class="c1"># Check grid index origin</span>
    <span class="n">geogrid_handedness</span> <span class="o">=</span> <span class="n">geogrid3D</span><span class="o">.</span><span class="n">grid_indexer</span><span class="o">.</span><span class="n">ijk_handedness</span>
    <span class="n">ertboxgrid_handedness</span> <span class="o">=</span> <span class="n">ertboxgrid3D</span><span class="o">.</span><span class="n">grid_indexer</span><span class="o">.</span><span class="n">ijk_handedness</span>

    <span class="k">if</span> <span class="n">geogrid_handedness</span> <span class="o">!=</span> <span class="n">ertboxgrid_handedness</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Grid model for geomodel &#39;</span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2">&#39; and &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;grid model for ERTBOX grid &#39;</span><span class="si">{</span><span class="n">ertbox_grid_model_name</span><span class="si">}</span><span class="s2">&#39;  &quot;</span>
            <span class="s2">&quot;have different grid index origin.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Use &#39;Eclipse grid standard&#39; (upper left corner) as &quot;</span>
            <span class="s2">&quot;common grid index origin (right-handed grid) in FMU projects using ERT.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">ertboxgrid_handedness</span> <span class="o">!=</span> <span class="n">rmsapi</span><span class="o">.</span><span class="n">Direction</span><span class="o">.</span><span class="n">right</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: ERTBOX grid should have &#39;Eclipse grid index origin&#39;.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Use the grid index origin job in RMS to set this.&quot;</span><span class="p">)</span>

    <span class="n">zone_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">zone_names_used</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_ON</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">- Copy RMS 3D parameters from </span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;to </span><span class="si">{</span><span class="n">ertbox_grid_model_name</span><span class="si">}</span><span class="s2"> for zones:&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_ON</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Continuous parameters:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">zone_number</span><span class="p">,</span> <span class="n">zone_name</span> <span class="ow">in</span> <span class="n">zone_code_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">zone_number</span> <span class="ow">in</span> <span class="n">param_names_geogrid_dict</span> <span class="ow">and</span> <span class="n">zone_number</span> <span class="ow">in</span> <span class="n">conformity_dict</span><span class="p">:</span>
            <span class="n">zone_dict</span><span class="p">[</span><span class="n">zone_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">zone_number</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">conformity_dict</span><span class="p">[</span><span class="n">zone_number</span><span class="p">],</span>
                <span class="n">continuous_type_param_dict</span><span class="p">[</span><span class="n">zone_number</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">zone_names_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_ON</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">zone_name</span><span class="si">}</span><span class="s2">:  </span><span class="si">{</span><span class="n">continuous_type_param_dict</span><span class="p">[</span><span class="n">zone_number</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_ON</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">discrete_type_param_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Discrete parameters:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">discrete_type_param_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

    <span class="n">copy_from_geo_to_ertbox_grid</span><span class="p">(</span>
        <span class="n">project</span><span class="p">,</span>
        <span class="n">grid_model_name</span><span class="p">,</span>
        <span class="n">ertbox_grid_model_name</span><span class="p">,</span>
        <span class="n">zone_dict</span><span class="p">,</span>
        <span class="n">method</span><span class="p">,</span>
        <span class="n">discrete_param_names</span><span class="o">=</span><span class="n">discrete_type_param_list</span><span class="p">,</span>
        <span class="n">debug_level</span><span class="o">=</span><span class="n">debug_level</span><span class="p">,</span>
        <span class="n">save_active_param</span><span class="o">=</span><span class="n">save_active_param</span><span class="p">,</span>
        <span class="n">add_noise_to_inactive</span><span class="o">=</span><span class="n">add_noise_to_inactive</span><span class="p">,</span>
        <span class="n">normalize_trend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">not_aps_workflow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_ON</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;- Finished copy rms parameters from </span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;to </span><span class="si">{</span><span class="n">ertbox_grid_model_name</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="from_ertbox_to_geogrid">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.from_ertbox_to_geogrid">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">from_ertbox_to_geogrid</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to copy a set of field parameters from ertbox grid into geogrid.</span>
<span class="sd">    A parameter in ertbox with name  zone_name + &#39;_&#39; + petrovariablename</span>
<span class="sd">    is copied into the variable with name petrovariablename in the geogrid</span>
<span class="sd">    and only into the zone with the correct name.</span>
<span class="sd">    The input is a dictionary with specification of grid names, parameter names,</span>
<span class="sd">    grid layout (conformity).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">real_number</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">current_realisation</span>
    <span class="c1"># Assign user specified parameters</span>
    <span class="n">grid_model_name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;GridModelName&quot;</span><span class="p">]</span>
    <span class="n">ertbox_grid_model_name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ERTBoxGridName&quot;</span><span class="p">]</span>
    <span class="n">param_names_geogrid_dict</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;GeoGridParameters&quot;</span><span class="p">]</span>
    <span class="n">param_names_ertbox_dict</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ErtboxParameters&quot;</span><span class="p">]</span>
    <span class="n">conformity_dict_input</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;Conformity&quot;</span><span class="p">]</span>
    <span class="n">debug_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;debug_level&quot;</span><span class="p">])</span>

    <span class="c1"># Some conversion</span>
    <span class="n">conformity_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">znr</span><span class="p">,</span> <span class="n">conform_text</span> <span class="ow">in</span> <span class="n">conformity_dict_input</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">conformity_dict</span><span class="p">[</span><span class="n">znr</span><span class="p">]</span> <span class="o">=</span> <span class="n">conform_text</span>

    <span class="c1"># Create</span>
    <span class="n">geogrid_model</span><span class="p">,</span> <span class="n">grid3D</span> <span class="o">=</span> <span class="n">get_grid_model</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">grid_model_name</span><span class="p">)</span>
    <span class="n">ertbox_grid_model</span><span class="p">,</span> <span class="n">ertbox3D</span> <span class="o">=</span> <span class="n">get_grid_model</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">ertbox_grid_model_name</span><span class="p">)</span>

    <span class="c1"># Check grid index origin</span>
    <span class="n">geogrid_handedness</span> <span class="o">=</span> <span class="n">grid3D</span><span class="o">.</span><span class="n">grid_indexer</span><span class="o">.</span><span class="n">ijk_handedness</span>
    <span class="n">ertboxgrid_handedness</span> <span class="o">=</span> <span class="n">ertbox3D</span><span class="o">.</span><span class="n">grid_indexer</span><span class="o">.</span><span class="n">ijk_handedness</span>
    <span class="k">if</span> <span class="n">geogrid_handedness</span> <span class="o">!=</span> <span class="n">ertboxgrid_handedness</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Grid model for geomodel &#39;</span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2">&#39; and &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;grid model for ERTBOX grid &#39;</span><span class="si">{</span><span class="n">ertbox_grid_model_name</span><span class="si">}</span><span class="s2">&#39;  &quot;</span>
            <span class="s2">&quot;have different grid index origin.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Use &#39;Eclipse grid standard&#39; (upper left corner) as &quot;</span>
            <span class="s2">&quot;common grid index origin (right-handed grid) in FMU projects using ERT.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">ertboxgrid_handedness</span> <span class="o">!=</span> <span class="n">rmsapi</span><span class="o">.</span><span class="n">Direction</span><span class="o">.</span><span class="n">right</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: ERTBOX grid should have &#39;Eclipse grid index origin&#39;.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Use the grid index origin job in RMS to set this.&quot;</span><span class="p">)</span>

    <span class="n">number_of_layers_per_zone_in_geo_grid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_zone_layer_numbering</span><span class="p">(</span><span class="n">grid3D</span><span class="p">)</span>
    <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz_ertbox</span> <span class="o">=</span> <span class="n">ertbox3D</span><span class="o">.</span><span class="n">simbox_indexer</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="k">for</span> <span class="n">zone_number</span> <span class="ow">in</span> <span class="n">param_names_geogrid_dict</span><span class="p">:</span>
        <span class="n">zone_index</span> <span class="o">=</span> <span class="n">zone_number</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">conformity</span> <span class="o">=</span> <span class="n">conformity_dict</span><span class="p">[</span><span class="n">zone_number</span><span class="p">]</span>
        <span class="n">param_names_geogrid_list</span> <span class="o">=</span> <span class="n">param_names_geogrid_dict</span><span class="p">[</span><span class="n">zone_number</span><span class="p">]</span>
        <span class="n">param_names_ertbox_list</span> <span class="o">=</span> <span class="n">param_names_ertbox_dict</span><span class="p">[</span><span class="n">zone_number</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Zone number:  </span><span class="si">{</span><span class="n">zone_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Conformity: </span><span class="si">{</span><span class="n">conformity</span><span class="si">}</span><span class="s2">  &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Copy from:  </span><span class="si">{</span><span class="n">param_names_ertbox_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Copy to:    </span><span class="si">{</span><span class="n">param_names_geogrid_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">nz_for_zone</span> <span class="o">=</span> <span class="n">number_of_layers_per_zone_in_geo_grid</span><span class="p">[</span><span class="n">zone_index</span><span class="p">]</span>
        <span class="n">parameter_names_geo_grid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parameter_values_geo_grid</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names_ertbox_list</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rms_property</span> <span class="o">=</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The parameter: </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> does not exist or is &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;empty for grid model: </span><span class="si">{</span><span class="n">ertbox_grid_model_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">rms_property</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">realisation</span><span class="o">=</span><span class="n">real_number</span><span class="p">)</span>
            <span class="n">field_values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz_ertbox</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conformity</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Proportional&quot;</span><span class="p">,</span> <span class="s2">&quot;TopConform&quot;</span><span class="p">):</span>
                <span class="c1"># Only get the top n cells of field_values</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="n">field_values</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">nz_for_zone</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">conformity</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BaseConform&quot;</span><span class="p">):</span>
                <span class="c1"># Get the bottom n cells of field_values</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="n">field_values</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="n">nz_for_zone</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">conformity</span><span class="si">}</span><span class="s2"> is not supported&quot;</span><span class="p">)</span>

            <span class="c1"># Field names and corresponding values to update the geo grid with</span>
            <span class="n">param_name_geo</span> <span class="o">=</span> <span class="n">param_names_geogrid_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">parameter_names_geo_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_name_geo</span><span class="p">)</span>
            <span class="n">parameter_values_geo_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>

        <span class="c1"># Update geogrid. Has often multiple zones</span>
        <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERY_VERBOSE</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parameter_names_geo_grid</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;--- Update parameter </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> for zone number &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zone_number</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">geogrid_model</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">set_continuous_3d_parameter_values_in_zone_region</span><span class="p">(</span>
            <span class="n">geogrid_model</span><span class="p">,</span>
            <span class="n">parameter_names_geo_grid</span><span class="p">,</span>
            <span class="n">parameter_values_geo_grid</span><span class="p">,</span>
            <span class="n">zone_number</span><span class="p">,</span>
            <span class="n">realisation_number</span><span class="o">=</span><span class="n">project</span><span class="o">.</span><span class="n">current_realisation</span><span class="p">,</span>
            <span class="n">is_shared</span><span class="o">=</span><span class="n">geogrid_model</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span>
            <span class="n">switch_handedness</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_ON</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;- Finished copy rms parameters from </span><span class="si">{</span><span class="n">ertbox_grid_model_name</span><span class="si">}</span><span class="s2">  &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;to </span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="get_zone_layer_numbering">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.get_zone_layer_numbering">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_zone_layer_numbering</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
    <span class="n">indexer</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">simbox_indexer</span>
    <span class="n">number_layers_per_zone</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_layers_per_zone</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">end_layers_per_zone</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">zonation</span><span class="p">:</span>
        <span class="n">layer_ranges</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">zonation</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">number_layers</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer_ranges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># Required for simbox indexer</span>
        <span class="n">layer_range</span> <span class="o">=</span> <span class="n">layer_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">layer_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">layer_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">number_layers</span> <span class="o">+=</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">number_layers_per_zone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number_layers</span><span class="p">)</span>
        <span class="n">start_layers_per_zone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">end_layers_per_zone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">number_layers_per_zone</span><span class="p">,</span> <span class="n">start_layers_per_zone</span><span class="p">,</span> <span class="n">end_layers_per_zone</span></div>



<div class="viewcode-block" id="get_grid_model">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.get_grid_model">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_grid_model</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">grid_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For given grid model name, return grid_model and grid objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">grid_model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">grid_models</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid model </span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
    <span class="n">grid_model</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">grid_models</span><span class="p">[</span><span class="n">grid_model_name</span><span class="p">]</span>
    <span class="n">real_number</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">current_realisation</span>
    <span class="k">if</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">is_empty</span><span class="p">(</span><span class="n">realisation</span><span class="o">=</span><span class="n">real_number</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid model </span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2"> is empty. &quot;</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="n">realisation</span><span class="o">=</span><span class="n">real_number</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grid_model</span><span class="p">,</span> <span class="n">grid</span></div>



<div class="viewcode-block" id="check_and_get_grid_dimensions">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.check_and_get_grid_dimensions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_and_get_grid_dimensions</span><span class="p">(</span>
    <span class="n">geogrid</span><span class="p">,</span> <span class="n">ertboxgrid</span><span class="p">,</span> <span class="n">geo_grid_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ertbox_grid_model_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given geogrid and ertbox grid return grid dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">geogrid_dims</span> <span class="o">=</span> <span class="n">geogrid</span><span class="o">.</span><span class="n">simbox_indexer</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="n">ertbox_dims</span> <span class="o">=</span> <span class="n">ertboxgrid</span><span class="o">.</span><span class="n">simbox_indexer</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">geogrid_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">geogrid_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="n">geogrid_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ertbox_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nx</span> <span class="ow">or</span> <span class="n">ertbox_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ny</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Grid dimensions nx and ny for geogrid </span><span class="si">{</span><span class="n">geo_grid_model_name</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;and ertbox grid </span><span class="si">{</span><span class="n">ertbox_grid_model_name</span><span class="si">}</span><span class="s2"> must be equal.&quot;</span>
        <span class="p">)</span>
    <span class="n">nz_ertbox</span> <span class="o">=</span> <span class="n">ertbox_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">nz_ertbox</span></div>



<div class="viewcode-block" id="get_grid_indices">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.get_grid_indices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_grid_indices</span><span class="p">(</span><span class="n">geogrid</span><span class="p">,</span> <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start_layer</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">end_layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">indexer</span> <span class="o">=</span> <span class="n">geogrid</span><span class="o">.</span><span class="n">simbox_indexer</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ijk_handedness</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">ijk_handedness</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">ijk_handedness</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">handedness</span>

    <span class="n">zone_cell_numbers</span> <span class="o">=</span> <span class="n">geogrid</span><span class="o">.</span><span class="n">simbox_indexer</span><span class="o">.</span><span class="n">get_cell_numbers_in_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="n">defined_cell_indices</span> <span class="o">=</span> <span class="n">geogrid</span><span class="o">.</span><span class="n">simbox_indexer</span><span class="o">.</span><span class="n">get_indices</span><span class="p">(</span><span class="n">zone_cell_numbers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ijk_handedness</span> <span class="o">==</span> <span class="n">Direction</span><span class="o">.</span><span class="n">right</span><span class="p">:</span>
        <span class="n">i_indices</span> <span class="o">=</span> <span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">j_indices</span> <span class="o">=</span> <span class="o">-</span><span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i_indices</span> <span class="o">=</span> <span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">j_indices</span> <span class="o">=</span> <span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">k_indices</span> <span class="o">=</span> <span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">,</span> <span class="n">k_indices</span><span class="p">,</span> <span class="n">zone_cell_numbers</span></div>



<div class="viewcode-block" id="active_params_in_zone">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.active_params_in_zone">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">active_params_in_zone</span><span class="p">(</span>
    <span class="n">geo_i_indices</span><span class="p">,</span>
    <span class="n">geo_j_indices</span><span class="p">,</span>
    <span class="n">geo_k_indices</span><span class="p">,</span>
    <span class="n">geo_nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">geo_ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">geo_nz</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">nz_ertbox</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">conformity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">number_layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">start_layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">end_layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Define active parameter for geogrid</span>
    <span class="n">active_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">geo_nx</span><span class="p">,</span> <span class="n">geo_ny</span><span class="p">,</span> <span class="n">geo_nz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">active_3d</span><span class="p">[</span><span class="n">geo_i_indices</span><span class="p">,</span> <span class="n">geo_j_indices</span><span class="p">,</span> <span class="n">geo_k_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Initially mask all values for ertbox parameter</span>
    <span class="n">ertbox_active_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">geo_nx</span><span class="p">,</span> <span class="n">geo_ny</span><span class="p">,</span> <span class="n">nz_ertbox</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conformity</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;BaseConform&quot;</span><span class="p">]:</span>
        <span class="c1"># Only copy the geogrid layers for the zone into the lowermost ertbox layers</span>
        <span class="n">ertbox_active_3d</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="n">number_layers</span><span class="p">:]</span> <span class="o">=</span> <span class="n">active_3d</span><span class="p">[</span>
            <span class="p">:,</span> <span class="p">:,</span> <span class="n">start_layer</span> <span class="p">:</span> <span class="p">(</span><span class="n">end_layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">elif</span> <span class="n">conformity</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TopConform&quot;</span><span class="p">,</span> <span class="s2">&quot;Proportional&quot;</span><span class="p">]:</span>
        <span class="c1"># Only copy the geogrid layers for the zone into the uppermost ertbox layers</span>
        <span class="n">ertbox_active_3d</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">number_layers</span><span class="p">]</span> <span class="o">=</span> <span class="n">active_3d</span><span class="p">[</span>
            <span class="p">:,</span> <span class="p">:,</span> <span class="n">start_layer</span> <span class="p">:</span> <span class="p">(</span><span class="n">end_layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid conformity: </span><span class="si">{</span><span class="n">conformity</span><span class="si">}</span><span class="s2"> is not supported.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ertbox_active_3d</span><span class="p">,</span> <span class="n">geo_nx</span> <span class="o">*</span> <span class="n">geo_ny</span> <span class="o">*</span> <span class="n">nz_ertbox</span><span class="p">)</span></div>



<div class="viewcode-block" id="ertbox_active_param_to_rms">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.ertbox_active_param_to_rms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ertbox_active_param_to_rms</span><span class="p">(</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">real_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">zone_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ertbox_grid_model</span><span class="p">,</span>
    <span class="n">ertbox_active</span><span class="p">,</span>
    <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Create and save a parameter for grid cells in ERTBOX</span>
    <span class="c1"># corresponding to active cells from geomodel for current geomodel zone</span>
    <span class="n">active_param_name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">zone_name</span> <span class="o">+</span> <span class="s2">&quot;_active&quot;</span>
    <span class="k">if</span> <span class="n">active_param_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
        <span class="n">ertbox_active_param</span> <span class="o">=</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">active_param_name</span><span class="p">,</span>
            <span class="n">property_type</span><span class="o">=</span><span class="n">rmsapi</span><span class="o">.</span><span class="n">GridPropertyType</span><span class="o">.</span><span class="n">discrete</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ertbox_active_param</span> <span class="o">=</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">active_param_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Update parameter: </span><span class="si">{</span><span class="n">active_param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ertbox_active_param</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">ertbox_active</span><span class="p">,</span> <span class="n">real_number</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ertbox_active_param</span></div>



<div class="viewcode-block" id="define_active_parameters_in_ertbox">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.define_active_parameters_in_ertbox">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">define_active_parameters_in_ertbox</span><span class="p">(</span>
    <span class="n">project</span><span class="p">,</span>
    <span class="n">geo_grid_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ertbox_grid_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">zone_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span><span class="p">,</span>
    <span class="n">not_aps_workflow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    zone_dict[zone_name] = (zone_number, region_number, conformity, param_name_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">real_number</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">current_realisation</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">geogrid</span> <span class="o">=</span> <span class="n">get_grid_model</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">geo_grid_model_name</span><span class="p">)</span>
    <span class="n">ertbox_grid_model</span><span class="p">,</span> <span class="n">ertboxgrid</span> <span class="o">=</span> <span class="n">get_grid_model</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">ertbox_grid_model_name</span><span class="p">)</span>

    <span class="c1"># Both ERTBOX grid and geogrid should have same nx, ny dimensions</span>
    <span class="c1"># nz is here the geogrid number of layers for all zones</span>
    <span class="c1"># nz_ertbox is number of layers in total in ERTBOX grid</span>
    <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">nz_ertbox</span> <span class="o">=</span> <span class="n">check_and_get_grid_dimensions</span><span class="p">(</span>
        <span class="n">geogrid</span><span class="p">,</span> <span class="n">ertboxgrid</span><span class="p">,</span> <span class="n">geo_grid_model_name</span><span class="p">,</span> <span class="n">ertbox_grid_model_name</span>
    <span class="p">)</span>

    <span class="n">number_layers_per_zone</span><span class="p">,</span> <span class="n">start_layers_per_zone</span><span class="p">,</span> <span class="n">end_layers_per_zone</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">get_zone_layer_numbering</span><span class="p">(</span><span class="n">geogrid</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Get zone_name and parameter names from model specification</span>
    <span class="k">for</span> <span class="n">zone_name</span><span class="p">,</span> <span class="n">zone_item</span> <span class="ow">in</span> <span class="n">zone_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">zone_number</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">conformity</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">zone_item</span>
        <span class="n">conformity</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">conformity</span><span class="p">)</span>
        <span class="n">zone_index</span> <span class="o">=</span> <span class="n">zone_number</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">number_layers</span> <span class="o">=</span> <span class="n">number_layers_per_zone</span><span class="p">[</span><span class="n">zone_index</span><span class="p">]</span>
        <span class="n">start_layer</span> <span class="o">=</span> <span class="n">start_layers_per_zone</span><span class="p">[</span><span class="n">zone_index</span><span class="p">]</span>
        <span class="n">end_layer</span> <span class="o">=</span> <span class="n">end_layers_per_zone</span><span class="p">[</span><span class="n">zone_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">number_layers</span> <span class="o">&gt;</span> <span class="n">nz_ertbox</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of layers of </span><span class="si">{</span><span class="n">ertbox_grid_model_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">nz_ertbox</span><span class="si">}</span><span class="s2">) &quot;</span>
                <span class="s2">&quot;is less than number of layers in &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">geo_grid_model_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">number_layers</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;for zone </span><span class="si">{</span><span class="n">zone_name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERY_VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- zone name: </span><span class="si">{</span><span class="n">zone_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- number_layers: </span><span class="si">{</span><span class="n">number_layers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- start_layer: </span><span class="si">{</span><span class="n">start_layer</span><span class="si">}</span><span class="s2">  end_layer: </span><span class="si">{</span><span class="n">end_layer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">,</span> <span class="n">k_indices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_grid_indices</span><span class="p">(</span>
            <span class="n">geogrid</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">start_layer</span><span class="p">,</span> <span class="n">end_layer</span>
        <span class="p">)</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;aps_&quot;</span>
        <span class="k">if</span> <span class="n">not_aps_workflow</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># The active cells as array</span>
        <span class="n">ertbox_active</span> <span class="o">=</span> <span class="n">active_params_in_zone</span><span class="p">(</span>
            <span class="n">i_indices</span><span class="p">,</span>
            <span class="n">j_indices</span><span class="p">,</span>
            <span class="n">k_indices</span><span class="p">,</span>
            <span class="n">nx</span><span class="p">,</span>
            <span class="n">ny</span><span class="p">,</span>
            <span class="n">nz</span><span class="p">,</span>
            <span class="n">nz_ertbox</span><span class="p">,</span>
            <span class="n">conformity</span><span class="p">,</span>
            <span class="n">number_layers</span><span class="p">,</span>
            <span class="n">start_layer</span><span class="p">,</span>
            <span class="n">end_layer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Active stored in RMS parameter</span>
        <span class="n">ertbox_active_param_to_rms</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="n">real_number</span><span class="p">,</span>
            <span class="n">zone_name</span><span class="p">,</span>
            <span class="n">ertbox_grid_model</span><span class="p">,</span>
            <span class="n">ertbox_active</span><span class="p">,</span>
            <span class="n">debug_level</span><span class="o">=</span><span class="n">debug_level</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="get_param_values">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.get_param_values">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_param_values</span><span class="p">(</span>
    <span class="n">geogrid_model</span><span class="p">,</span>
    <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">real_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">param_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geogrid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The 3D parameter </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> does not exist &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;in grid model </span><span class="si">{</span><span class="n">geogrid_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">param</span> <span class="o">=</span> <span class="n">geogrid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">is_empty</span><span class="p">(</span><span class="n">realisation</span><span class="o">=</span><span class="n">real_number</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Grid parameter </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">geogrid_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is empty.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">param</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">realisation</span><span class="o">=</span><span class="n">real_number</span><span class="p">)</span></div>



<div class="viewcode-block" id="copy_parameters_for_zone">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.copy_parameters_for_zone">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">copy_parameters_for_zone</span><span class="p">(</span>
    <span class="n">zone_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">geogrid_model</span><span class="p">,</span>
    <span class="n">ertbox_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">i_indices</span><span class="p">,</span>
    <span class="n">j_indices</span><span class="p">,</span>
    <span class="n">k_indices</span><span class="p">,</span>
    <span class="n">zone_cell_numbers</span><span class="p">,</span>
    <span class="n">conformity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">nz</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">nz_ertbox</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">number_layers</span><span class="p">,</span>
    <span class="n">start_layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">end_layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">real_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">param_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
    <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">    For specified zone name a parameter from the geomodel is copied</span>
<span class="sd">    to the ertbox grid. The i,j,k indices coming from the geogrid</span>
<span class="sd">    defines the (i,j,k) indices with actively used values.</span>
<span class="sd">    The zone_cell_numbers define active cell numbers in geomodel.</span>
<span class="sd">    The mapping from geogrid to ertbox grid is defined by the</span>
<span class="sd">    specified geogrid conformity and the layer interval.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">param_values_active</span> <span class="o">=</span> <span class="n">get_param_values</span><span class="p">(</span><span class="n">geogrid_model</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">real_number</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Zone: </span><span class="si">{</span><span class="n">zone_name</span><span class="si">}</span><span class="s2"> Parameter:</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

    <span class="c1"># Mask all values for geogrid parameter except the active values within the zone</span>
    <span class="k">if</span> <span class="n">param_type</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
        <span class="n">param_values_3d_all</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">param_type</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
        <span class="n">param_values_3d_all</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter type must be &#39;float&#39; or &#39;int&#39; &quot;</span><span class="p">)</span>
    <span class="n">param_values_3d_all</span><span class="p">[</span><span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">,</span> <span class="n">k_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_values_active</span><span class="p">[</span>
        <span class="n">zone_cell_numbers</span>
    <span class="p">]</span>

    <span class="c1"># Initially mask all values for ertbox parameter</span>
    <span class="k">if</span> <span class="n">param_type</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
        <span class="n">ertbox_values_3d_masked</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz_ertbox</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ertbox_values_3d_masked</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz_ertbox</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERY_VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;--- Parameter </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">  for zone: </span><span class="si">{</span><span class="n">zone_name</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;is copied to </span><span class="si">{</span><span class="n">ertbox_model_name</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># The RMS simbox layers (num_layers) are copied into ertbox grid</span>
    <span class="c1"># at top if grid layout is top conform or proportional and</span>
    <span class="c1"># at the bottom if grid layout is base conform.</span>
    <span class="c1"># Must be consistent with export_fields_to_disk.py</span>
    <span class="k">if</span> <span class="n">conformity</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;BaseConform&quot;</span><span class="p">]:</span>
        <span class="c1"># Only copy the geogrid layers for the zone into the lowermost ertbox layers</span>
        <span class="n">ertbox_values_3d_masked</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="n">number_layers</span><span class="p">:]</span> <span class="o">=</span> <span class="n">param_values_3d_all</span><span class="p">[</span>
            <span class="p">:,</span> <span class="p">:,</span> <span class="n">start_layer</span> <span class="p">:</span> <span class="p">(</span><span class="n">end_layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">elif</span> <span class="n">conformity</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TopConform&quot;</span><span class="p">,</span> <span class="s2">&quot;Proportional&quot;</span><span class="p">]:</span>
        <span class="c1"># Only copy the geogrid layers for the zone into the uppermost ertbox layers</span>
        <span class="n">ertbox_values_3d_masked</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">number_layers</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_values_3d_all</span><span class="p">[</span>
            <span class="p">:,</span> <span class="p">:,</span> <span class="n">start_layer</span> <span class="p">:</span> <span class="p">(</span><span class="n">end_layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid conformity: </span><span class="si">{</span><span class="n">conformity</span><span class="si">}</span><span class="s2"> is not supported.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ertbox_values_3d_masked</span></div>



<div class="viewcode-block" id="update_ertbox_properties_int">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.update_ertbox_properties_int">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_ertbox_properties_int</span><span class="p">(</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">zone_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ertbox_grid_model</span><span class="p">,</span>
    <span class="n">ertbox_values</span><span class="p">,</span>
    <span class="n">real_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Create /Update ertbox properties in RMS</span>
    <span class="n">full_param_name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">zone_name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">param_name</span>
    <span class="k">if</span> <span class="n">full_param_name</span> <span class="ow">in</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
        <span class="n">ertbox_param</span> <span class="o">=</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">full_param_name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ertbox_param</span> <span class="o">=</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">full_param_name</span><span class="p">,</span>
            <span class="n">property_type</span><span class="o">=</span><span class="n">rmsapi</span><span class="o">.</span><span class="n">GridPropertyType</span><span class="o">.</span><span class="n">discrete</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">ertbox_param</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">ertbox_values</span><span class="p">,</span> <span class="n">real_number</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Update parameter: </span><span class="si">{</span><span class="n">full_param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_ertbox_properties_float">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.update_ertbox_properties_float">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_ertbox_properties_float</span><span class="p">(</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">zone_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ertbox_grid_model</span><span class="p">,</span>
    <span class="n">ertbox_values</span><span class="p">,</span>
    <span class="n">real_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">normalize_trend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Create /Update ertbox properties in RMS</span>
    <span class="n">full_param_name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">zone_name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">param_name</span>
    <span class="k">if</span> <span class="n">full_param_name</span> <span class="ow">in</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
        <span class="n">ertbox_param</span> <span class="o">=</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">full_param_name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ertbox_param</span> <span class="o">=</span> <span class="n">ertbox_grid_model</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">full_param_name</span><span class="p">,</span>
            <span class="n">property_type</span><span class="o">=</span><span class="n">rmsapi</span><span class="o">.</span><span class="n">GridPropertyType</span><span class="o">.</span><span class="n">continuous</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">ertbox_param</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">ertbox_values</span><span class="p">,</span> <span class="n">real_number</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERBOSE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">normalize_trend</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Update parameter (normalized): </span><span class="si">{</span><span class="n">full_param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Update parameter: </span><span class="si">{</span><span class="n">full_param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="assign_undefined_constant">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.assign_undefined_constant">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">assign_undefined_constant</span><span class="p">(</span>
    <span class="n">ertbox_values_3d_masked</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERY_VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- All inactive values set to:</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ertbox_values_3d_masked</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="fill_remaining_masked_values_within_colum">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.fill_remaining_masked_values_within_colum">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fill_remaining_masked_values_within_colum</span><span class="p">(</span><span class="n">column_values_masked</span><span class="p">,</span> <span class="n">nz_ertbox</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">column_values_masked</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">column_values_masked</span>
    <span class="n">index_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nz_ertbox</span><span class="p">)</span>
    <span class="n">work_array</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">list_of_unmasked_intervals</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">notmasked_contiguous</span><span class="p">(</span><span class="n">column_values_masked</span><span class="p">)</span>
    <span class="n">current_slice</span> <span class="o">=</span> <span class="n">list_of_unmasked_intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">current_index_interval</span> <span class="o">=</span> <span class="n">index_array</span><span class="p">[</span><span class="n">current_slice</span><span class="p">]</span>
    <span class="n">last_index</span> <span class="o">=</span> <span class="n">current_index_interval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">work_array</span><span class="p">[</span><span class="n">last_index</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_unmasked_intervals</span><span class="p">)):</span>
        <span class="n">prev_last_index</span> <span class="o">=</span> <span class="n">last_index</span>
        <span class="n">current_slice</span> <span class="o">=</span> <span class="n">list_of_unmasked_intervals</span><span class="p">[</span><span class="n">number</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">index_array</span><span class="p">[</span><span class="n">current_slice</span><span class="p">]</span>
        <span class="n">first_index</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">first_index</span> <span class="o">-</span> <span class="n">prev_last_index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">work_array</span><span class="p">[</span><span class="n">prev_last_index</span><span class="p">]</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">work_array</span><span class="p">[</span><span class="n">first_index</span><span class="p">]</span>
        <span class="c1"># Linear interpolate and assign to masked values</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">first_index</span> <span class="o">-</span> <span class="n">prev_last_index</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">prev_last_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">first_index</span><span class="p">):</span>
            <span class="n">column_values_masked</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v0</span><span class="p">)</span> <span class="o">*</span> <span class="n">indx</span> <span class="o">/</span> <span class="n">n</span>
            <span class="n">indx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">column_values_masked</span></div>



<div class="viewcode-block" id="assign_undefined_vertical">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.assign_undefined_vertical">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">assign_undefined_vertical</span><span class="p">(</span>
    <span class="n">method</span><span class="p">,</span> <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nz_ertbox</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ertbox_values_3d_masked</span><span class="p">,</span> <span class="n">fill_value</span>
<span class="p">):</span>
    <span class="n">k_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nz_ertbox</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="n">column_values_masked</span> <span class="o">=</span> <span class="n">ertbox_values_3d_masked</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">defined_k_indices</span> <span class="o">=</span> <span class="n">k_indices</span><span class="p">[</span><span class="o">~</span><span class="n">column_values_masked</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">defined_k_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">top_k</span> <span class="o">=</span> <span class="n">defined_k_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">bottom_k</span> <span class="o">=</span> <span class="n">defined_k_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">top_value</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span><span class="n">top_k</span><span class="p">]</span>
                <span class="n">bottom_value</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span><span class="n">bottom_k</span><span class="p">]</span>
                <span class="n">undefined_k_indices_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">top_k</span><span class="p">)</span>
                <span class="n">undefined_k_indices_bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bottom_k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nz_ertbox</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;extend&quot;</span><span class="p">,</span> <span class="s2">&quot;extend_layer_mean&quot;</span><span class="p">]:</span>
                    <span class="n">column_values_masked</span><span class="p">[</span><span class="n">undefined_k_indices_top</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_value</span>
                    <span class="n">column_values_masked</span><span class="p">[</span><span class="n">undefined_k_indices_bottom</span><span class="p">]</span> <span class="o">=</span> <span class="n">bottom_value</span>
                    <span class="n">column_values_masked</span> <span class="o">=</span> <span class="n">fill_remaining_masked_values_within_colum</span><span class="p">(</span>
                        <span class="n">column_values_masked</span><span class="p">,</span> <span class="n">nz_ertbox</span>
                    <span class="p">)</span>
                    <span class="n">ertbox_values_3d_masked</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">column_values_masked</span>

                <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat_layer_mean&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">undefined_k_indices_top</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">undefined_k_indices_top</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">defined_k_indices</span><span class="p">)</span>
                        <span class="n">values_for_undefined</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span>
                            <span class="n">undefined_k_indices_top</span>
                        <span class="p">]</span>
                        <span class="n">values_for_undefined</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">bottom_value</span>
                        <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
                            <span class="n">values_for_undefined</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span>
                                <span class="n">defined_k_indices</span>
                            <span class="p">]</span>
                        <span class="k">elif</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span><span class="n">defined_k_indices</span><span class="p">]</span>
                            <span class="n">values_for_undefined</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[:</span><span class="n">m</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">values_for_undefined</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span>
                                <span class="n">defined_k_indices</span>
                            <span class="p">]</span>

                        <span class="n">reverse_values_for_undefined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span>
                            <span class="n">values_for_undefined</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">column_values_masked</span><span class="p">[</span><span class="n">undefined_k_indices_top</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">reverse_values_for_undefined</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">undefined_k_indices_bottom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">undefined_k_indices_bottom</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">defined_k_indices</span><span class="p">)</span>
                        <span class="n">values_for_undefined</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span>
                            <span class="n">undefined_k_indices_bottom</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">values_for_undefined</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">top_value</span>
                        <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
                            <span class="n">values_for_undefined</span><span class="p">[(</span><span class="n">m</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span>
                                <span class="n">defined_k_indices</span>
                            <span class="p">]</span>
                        <span class="k">elif</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span><span class="n">defined_k_indices</span><span class="p">]</span>
                            <span class="n">values_for_undefined</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[(</span><span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">values_for_undefined</span> <span class="o">=</span> <span class="n">column_values_masked</span><span class="p">[</span>
                                <span class="n">defined_k_indices</span>
                            <span class="p">]</span>

                        <span class="n">reverse_values_for_undefined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span>
                            <span class="n">values_for_undefined</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">column_values_masked</span><span class="p">[</span><span class="n">undefined_k_indices_bottom</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">reverse_values_for_undefined</span>
                        <span class="p">)</span>

                    <span class="n">column_values_masked</span> <span class="o">=</span> <span class="n">fill_remaining_masked_values_within_colum</span><span class="p">(</span>
                        <span class="n">column_values_masked</span><span class="p">,</span> <span class="n">nz_ertbox</span>
                    <span class="p">)</span>
                    <span class="n">ertbox_values_3d_masked</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">column_values_masked</span>

    <span class="k">return</span> <span class="n">ertbox_values_3d_masked</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span></div>



<div class="viewcode-block" id="assign_undefined_lateral">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.assign_undefined_lateral">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">assign_undefined_lateral</span><span class="p">(</span><span class="n">nz_ertbox</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ertbox_values_3d_masked</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz_ertbox</span><span class="p">):</span>
        <span class="n">layer_values</span> <span class="o">=</span> <span class="n">ertbox_values_3d_masked</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">layer_values</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ertbox_values_3d_masked</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">])</span>
            <span class="n">filled_layer_values</span> <span class="o">=</span> <span class="n">layer_values</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
            <span class="n">ertbox_values_3d_masked</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">filled_layer_values</span>
    <span class="k">return</span> <span class="n">ertbox_values_3d_masked</span></div>



<div class="viewcode-block" id="extrapolate_values_for_zone">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.extrapolate_values_for_zone">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extrapolate_values_for_zone</span><span class="p">(</span>
    <span class="n">ertbox_values_3d_masked</span><span class="p">,</span>
    <span class="n">extrapolation_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">nz_ertbox</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">,</span>
    <span class="n">add_noise_to_inactive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description:</span>
<span class="sd">    Here all inactive cells in ertbox are filled with values using</span>
<span class="sd">    some chosen extrapolation method. Returns a flatten 1D array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERBOSE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">extrapolation_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;-- Extrapolate parameter using option for undefined grid cells in &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ERTBOX: </span><span class="si">{</span><span class="n">extrapolation_method</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">add_noise_to_inactive</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;-- Add random noise to undefined grid cells in ERTBOX on top &quot;</span>
                <span class="s2">&quot;of the extrapolated values&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">add_noise_to_inactive</span><span class="p">:</span>
        <span class="c1"># The undefined grid cells before any of them are filled</span>
        <span class="n">undefined_grid_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ertbox_values_3d_masked</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

    <span class="n">vertical_methods</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;extend&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat&quot;</span><span class="p">)</span>

    <span class="n">vertical_horizontal_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;extend_layer_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat_layer_mean&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">extrapolation_method</span> <span class="ow">in</span> <span class="n">vertical_horizontal_methods</span><span class="p">:</span>
        <span class="n">ertbox_values_3d_masked</span> <span class="o">=</span> <span class="n">assign_undefined_lateral</span><span class="p">(</span>
            <span class="n">nz_ertbox</span><span class="p">,</span> <span class="n">ertbox_values_3d_masked</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">extrapolation_method</span> <span class="o">==</span> <span class="s2">&quot;zero&quot;</span><span class="p">:</span>
        <span class="n">ertbox_values_3d</span> <span class="o">=</span> <span class="n">assign_undefined_constant</span><span class="p">(</span>
            <span class="n">ertbox_values_3d_masked</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">debug_level</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">extrapolation_method</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ertbox_values_3d_masked</span><span class="p">)</span>
        <span class="n">ertbox_values_3d</span> <span class="o">=</span> <span class="n">assign_undefined_constant</span><span class="p">(</span>
            <span class="n">ertbox_values_3d_masked</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">debug_level</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">extrapolation_method</span> <span class="ow">in</span> <span class="n">vertical_methods</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">extrapolation_method</span> <span class="ow">in</span> <span class="n">vertical_horizontal_methods</span>
    <span class="p">):</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ertbox_values_3d_masked</span><span class="p">)</span>
        <span class="n">ertbox_values_3d</span> <span class="o">=</span> <span class="n">assign_undefined_vertical</span><span class="p">(</span>
            <span class="n">extrapolation_method</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz_ertbox</span><span class="p">,</span> <span class="n">ertbox_values_3d_masked</span><span class="p">,</span> <span class="n">mean</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Extrapolation method:</span><span class="si">{</span><span class="n">extrapolation_method</span><span class="si">}</span><span class="s2"> is not implemented.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Add random noise with low std dev to all values for undefined</span>
    <span class="c1"># grid cells that have been filled in the above extrapolation</span>
    <span class="c1"># This is to avoid creating ensemble of realizations where undefined grid cells</span>
    <span class="c1"># that are filled with extrapolated values get 0 standard deviation since</span>
    <span class="c1"># 0 standard deviation per today trigger errors in ERT with adaptive localisation.</span>
    <span class="k">if</span> <span class="n">add_noise_to_inactive</span><span class="p">:</span>
        <span class="n">ertbox_values_3d</span> <span class="o">=</span> <span class="n">add_noise_to_undefined_grid_cell_values</span><span class="p">(</span>
            <span class="n">ertbox_values_3d</span><span class="p">,</span> <span class="n">undefined_grid_cells</span><span class="p">,</span> <span class="n">seed</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ertbox_values_3d</span><span class="p">,</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">nz_ertbox</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_noise_to_undefined_grid_cell_values">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.add_noise_to_undefined_grid_cell_values">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_noise_to_undefined_grid_cell_values</span><span class="p">(</span>
    <span class="n">ertbox_values_3d_masked</span><span class="p">,</span>
    <span class="n">undefined_grid_cells</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_relative_noise</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ertbox_values_3d_masked</span><span class="p">)</span>
    <span class="n">low</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_relative_noise</span>
    <span class="c1"># To avoid making negative values for positive random numbers</span>
    <span class="c1"># (e.g. from lognormal distribution), add a small positive noise</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ertbox_values_3d_masked</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">ertbox_values_3d_masked</span><span class="p">[</span><span class="n">undefined_grid_cells</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ertbox_values_3d_masked</span><span class="p">[</span><span class="n">undefined_grid_cells</span><span class="p">]</span> <span class="o">+</span> <span class="n">noise</span><span class="p">[</span><span class="n">undefined_grid_cells</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ertbox_values_3d_masked</span></div>



<div class="viewcode-block" id="copy_from_geo_to_ertbox_grid">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.copy_from_geo_to_ertbox_grid">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">copy_from_geo_to_ertbox_grid</span><span class="p">(</span>
    <span class="n">project</span><span class="p">,</span>
    <span class="n">geo_grid_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ertbox_grid_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">zone_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">extrapolation_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">discrete_param_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span><span class="p">,</span>
    <span class="n">save_active_param</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">add_noise_to_inactive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">normalize_trend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">not_aps_workflow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copy grid parameters from geomodel grid to ertbox grid</span>
<span class="sd">    and both continuous and discrete parameters can be copied.</span>
<span class="sd">    Continuous parameters can be extrapolated in ertbox grid model.</span>

<span class="sd">    Input:</span>
<span class="sd">        geogrid name,</span>
<span class="sd">        ertbox grid name,</span>
<span class="sd">        parameters to be copied per zone (zone_dict) defined by</span>
<span class="sd">        zone_dict[zone_name] = (zone_number, region_number, conformity, param_name_list)</span>
<span class="sd">        extrapolation method for continuous 3D parameters,</span>

<span class="sd">    Optional input:</span>
<span class="sd">        list of discrete parameter names to be copied,</span>
<span class="sd">        debug_level (0 for off, 1 or larger for on),</span>
<span class="sd">        save_active_param (False/True) if this should be calculated,</span>
<span class="sd">        add_noise_to_inactive (False/True)  if random noise with small variance</span>
<span class="sd">        is to be added to grid cell values in ERTBOX grid that are extrapolated,</span>
<span class="sd">        normalize_trend (False/True) is only relevant when used in APS,</span>
<span class="sd">        not_aps_workflow (False/True) turn on prefix &#39;aps&#39; if False else no prefix</span>
<span class="sd">        for 3D parameters in ERTBOX grid,</span>
<span class="sd">        seed is input to random generator to draw the noise values</span>
<span class="sd">        if add_noise_to_inactive is True.</span>

<span class="sd">    Extrapolation alternative method:</span>

<span class="sd">        zero -  where all undefined cells get 0 as value</span>

<span class="sd">        mean - where all undefined cells get mean value of defined cell values</span>

<span class="sd">        extend_layer_mean - where all undefined values in a layer is replaced by the</span>
<span class="sd">                            layer average. For undefined grid cells above or below the</span>
<span class="sd">                            layers having some defined values, the upper most defined</span>
<span class="sd">                            cell value is copied to all undefined cell values above</span>
<span class="sd">                            this cell for each cell column and bottom most defined</span>
<span class="sd">                            cell value is copied to all undefined cell values below</span>
<span class="sd">                            this cell for each cell column.</span>

<span class="sd">        repeat_layer_mean - where all undefined values in a layer is replaced by the</span>
<span class="sd">                            layer average. For undefined cells above the uppermost</span>
<span class="sd">                            active cell are assigned the values of the active cells</span>
<span class="sd">                            in the same column but in reverse order to avoid</span>
<span class="sd">                            discontinuity at the border between the initially active</span>
<span class="sd">                            and undefined cell values. If the number of active cells</span>
<span class="sd">                            in a column is less than the undefined cells above the</span>
<span class="sd">                            uppermost active cell, they will be assigned a constant</span>
<span class="sd">                            value in the same way as option EXTEND_LAYER_MEAN.</span>
<span class="sd">                            The same procedure is used to fill in inactive cell</span>
<span class="sd">                            values below lowermost active cell.</span>

<span class="sd">        repeat -            where all undefined values in a column is defined by</span>
<span class="sd">                            repeating values upwards and downwards from the defined</span>
<span class="sd">                            value at the border between defined and undefined grid</span>
<span class="sd">                            cells. The repeat is taken in reverse order</span>
<span class="sd">                            (like making a mirror copy of the defined values upwards</span>
<span class="sd">                            and downwards from the defined to the undefined grid cells.)</span>

<span class="sd">        extend -            where all undefined values in a column is defined by</span>
<span class="sd">                            repeating values upwards and downwards from the defined</span>
<span class="sd">                            value at the border between defined and undefined grid</span>
<span class="sd">                            cells. The uppermost defined value is copied to all</span>
<span class="sd">                            undefined grid cells above and the lowermost defined</span>
<span class="sd">                            value is copied to all undefined grid cells below.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">real_number</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">current_realisation</span>
    <span class="n">geogrid_model</span><span class="p">,</span> <span class="n">geogrid</span> <span class="o">=</span> <span class="n">get_grid_model</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">geo_grid_model_name</span><span class="p">)</span>
    <span class="n">ertbox_grid_model</span><span class="p">,</span> <span class="n">ertboxgrid</span> <span class="o">=</span> <span class="n">get_grid_model</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">ertbox_grid_model_name</span><span class="p">)</span>

    <span class="c1"># Both ERTBOX grid and geogrid should have same nx, ny dimensions</span>
    <span class="c1"># nz is here the geogrid number of layers for all zones</span>
    <span class="c1"># nz_ertbox is number of layers in total in ERTBOX grid</span>
    <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">nz_ertbox</span> <span class="o">=</span> <span class="n">check_and_get_grid_dimensions</span><span class="p">(</span>
        <span class="n">geogrid</span><span class="p">,</span> <span class="n">ertboxgrid</span><span class="p">,</span> <span class="n">geo_grid_model_name</span><span class="p">,</span> <span class="n">ertbox_grid_model_name</span>
    <span class="p">)</span>

    <span class="n">number_layers_per_zone</span><span class="p">,</span> <span class="n">start_layers_per_zone</span><span class="p">,</span> <span class="n">end_layers_per_zone</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">get_zone_layer_numbering</span><span class="p">(</span><span class="n">geogrid</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Get parameter names from model specification</span>
    <span class="k">for</span> <span class="n">zone_name</span><span class="p">,</span> <span class="n">zone_item</span> <span class="ow">in</span> <span class="n">zone_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">zone_number</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">conformity</span><span class="p">,</span> <span class="n">param_name_list</span> <span class="o">=</span> <span class="n">zone_item</span>
        <span class="n">zone_index</span> <span class="o">=</span> <span class="n">zone_number</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">number_layers</span> <span class="o">=</span> <span class="n">number_layers_per_zone</span><span class="p">[</span><span class="n">zone_index</span><span class="p">]</span>
        <span class="n">start_layer</span> <span class="o">=</span> <span class="n">start_layers_per_zone</span><span class="p">[</span><span class="n">zone_index</span><span class="p">]</span>
        <span class="n">end_layer</span> <span class="o">=</span> <span class="n">end_layers_per_zone</span><span class="p">[</span><span class="n">zone_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">number_layers</span> <span class="o">&gt;</span> <span class="n">nz_ertbox</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of layers of </span><span class="si">{</span><span class="n">ertbox_grid_model_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">nz_ertbox</span><span class="si">}</span><span class="s2">) &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is less than number of layers in &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">geo_grid_model_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">number_layers</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;for zone </span><span class="si">{</span><span class="n">zone_name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERY_VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- zone name: </span><span class="si">{</span><span class="n">zone_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- number_layers: </span><span class="si">{</span><span class="n">number_layers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- start_layer: </span><span class="si">{</span><span class="n">start_layer</span><span class="si">}</span><span class="s2">  end_layer: </span><span class="si">{</span><span class="n">end_layer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">,</span> <span class="n">k_indices</span><span class="p">,</span> <span class="n">zone_cell_numbers</span> <span class="o">=</span> <span class="n">get_grid_indices</span><span class="p">(</span>
            <span class="n">geogrid</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">start_layer</span><span class="p">,</span> <span class="n">end_layer</span>
        <span class="p">)</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;aps_&quot;</span>
        <span class="k">if</span> <span class="n">not_aps_workflow</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># The active cells as array</span>
        <span class="n">ertbox_active</span> <span class="o">=</span> <span class="n">active_params_in_zone</span><span class="p">(</span>
            <span class="n">i_indices</span><span class="p">,</span>
            <span class="n">j_indices</span><span class="p">,</span>
            <span class="n">k_indices</span><span class="p">,</span>
            <span class="n">nx</span><span class="p">,</span>
            <span class="n">ny</span><span class="p">,</span>
            <span class="n">nz</span><span class="p">,</span>
            <span class="n">nz_ertbox</span><span class="p">,</span>
            <span class="n">conformity</span><span class="p">,</span>
            <span class="n">number_layers</span><span class="p">,</span>
            <span class="n">start_layer</span><span class="p">,</span>
            <span class="n">end_layer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Active stored in RMS parameter</span>
        <span class="k">if</span> <span class="n">save_active_param</span><span class="p">:</span>
            <span class="n">ertbox_active_param_to_rms</span><span class="p">(</span>
                <span class="n">prefix</span><span class="p">,</span>
                <span class="n">real_number</span><span class="p">,</span>
                <span class="n">zone_name</span><span class="p">,</span>
                <span class="n">ertbox_grid_model</span><span class="p">,</span>
                <span class="n">ertbox_active</span><span class="p">,</span>
                <span class="n">debug_level</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">discrete_param_names</span><span class="p">:</span>
            <span class="n">ertbox_values_3d_masked</span> <span class="o">=</span> <span class="n">copy_parameters_for_zone</span><span class="p">(</span>
                <span class="n">zone_name</span><span class="p">,</span>
                <span class="n">geogrid_model</span><span class="p">,</span>
                <span class="n">ertbox_grid_model_name</span><span class="p">,</span>
                <span class="n">param_name</span><span class="p">,</span>
                <span class="n">i_indices</span><span class="p">,</span>
                <span class="n">j_indices</span><span class="p">,</span>
                <span class="n">k_indices</span><span class="p">,</span>
                <span class="n">zone_cell_numbers</span><span class="p">,</span>
                <span class="n">conformity</span><span class="p">,</span>
                <span class="n">nx</span><span class="p">,</span>
                <span class="n">ny</span><span class="p">,</span>
                <span class="n">nz</span><span class="p">,</span>
                <span class="n">nz_ertbox</span><span class="p">,</span>
                <span class="n">number_layers</span><span class="p">,</span>
                <span class="n">start_layer</span><span class="p">,</span>
                <span class="n">end_layer</span><span class="p">,</span>
                <span class="n">real_number</span><span class="p">,</span>
                <span class="n">param_type</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
                <span class="n">debug_level</span><span class="o">=</span><span class="n">debug_level</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Inactive cells filled with -1</span>
            <span class="n">ertbox_values_3d</span> <span class="o">=</span> <span class="n">ertbox_values_3d_masked</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ertbox_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ertbox_values_3d</span><span class="p">,</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">nz_ertbox</span><span class="p">)</span>
            <span class="n">update_ertbox_properties_int</span><span class="p">(</span>
                <span class="n">prefix</span><span class="p">,</span>
                <span class="n">zone_name</span><span class="p">,</span>
                <span class="n">param_name</span><span class="p">,</span>
                <span class="n">ertbox_grid_model</span><span class="p">,</span>
                <span class="n">ertbox_values</span><span class="p">,</span>
                <span class="n">real_number</span><span class="p">,</span>
                <span class="n">debug_level</span><span class="o">=</span><span class="n">debug_level</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">param_name_list</span><span class="p">:</span>
            <span class="c1"># Copy parameter for give zone from geogrid to ertbox grid</span>
            <span class="n">ertbox_values_3d_masked</span> <span class="o">=</span> <span class="n">copy_parameters_for_zone</span><span class="p">(</span>
                <span class="n">zone_name</span><span class="p">,</span>
                <span class="n">geogrid_model</span><span class="p">,</span>
                <span class="n">ertbox_grid_model_name</span><span class="p">,</span>
                <span class="n">param_name</span><span class="p">,</span>
                <span class="n">i_indices</span><span class="p">,</span>
                <span class="n">j_indices</span><span class="p">,</span>
                <span class="n">k_indices</span><span class="p">,</span>
                <span class="n">zone_cell_numbers</span><span class="p">,</span>
                <span class="n">conformity</span><span class="p">,</span>
                <span class="n">nx</span><span class="p">,</span>
                <span class="n">ny</span><span class="p">,</span>
                <span class="n">nz</span><span class="p">,</span>
                <span class="n">nz_ertbox</span><span class="p">,</span>
                <span class="n">number_layers</span><span class="p">,</span>
                <span class="n">start_layer</span><span class="p">,</span>
                <span class="n">end_layer</span><span class="p">,</span>
                <span class="n">real_number</span><span class="p">,</span>
                <span class="n">param_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span>
                <span class="n">debug_level</span><span class="o">=</span><span class="n">debug_level</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Fill values for all inactive cells in ertbox</span>
            <span class="n">ertbox_values</span> <span class="o">=</span> <span class="n">extrapolate_values_for_zone</span><span class="p">(</span>
                <span class="n">ertbox_values_3d_masked</span><span class="p">,</span>
                <span class="n">extrapolation_method</span><span class="p">,</span>
                <span class="n">nx</span><span class="p">,</span>
                <span class="n">ny</span><span class="p">,</span>
                <span class="n">nz_ertbox</span><span class="p">,</span>
                <span class="n">debug_level</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                <span class="n">add_noise_to_inactive</span><span class="o">=</span><span class="n">add_noise_to_inactive</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Normalize values to be between 0 and 1 within this zone</span>
            <span class="k">if</span> <span class="n">normalize_trend</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Normalize parameter: </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
                <span class="n">selected_values</span> <span class="o">=</span> <span class="n">ertbox_values</span><span class="p">[</span><span class="n">ertbox_active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">minval</span> <span class="o">=</span> <span class="n">selected_values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">maxval</span> <span class="o">=</span> <span class="n">selected_values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">minmax_diff</span> <span class="o">=</span> <span class="n">maxval</span> <span class="o">-</span> <span class="n">minval</span>
                <span class="k">if</span> <span class="n">minmax_diff</span> <span class="o">&gt;</span> <span class="mf">0.000001</span><span class="p">:</span>
                    <span class="c1"># All values including the inactive cells are rescaled</span>
                    <span class="c1"># All active cell values will be between 0 and 1</span>
                    <span class="n">ertbox_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">ertbox_values</span> <span class="o">-</span> <span class="n">minval</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">minmax_diff</span><span class="p">)</span>

                    <span class="c1"># All values for inactive cells should also be &gt;= 0</span>
                    <span class="n">ertbox_values</span><span class="p">[</span><span class="n">ertbox_values</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Constant trend equal to 0 is set if trend is constant</span>
                    <span class="n">ertbox_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># Create /Update ertbox properties in RMS</span>
            <span class="n">update_ertbox_properties_float</span><span class="p">(</span>
                <span class="n">prefix</span><span class="p">,</span>
                <span class="n">zone_name</span><span class="p">,</span>
                <span class="n">param_name</span><span class="p">,</span>
                <span class="n">ertbox_grid_model</span><span class="p">,</span>
                <span class="n">ertbox_values</span><span class="p">,</span>
                <span class="n">real_number</span><span class="p">,</span>
                <span class="n">normalize_trend</span><span class="o">=</span><span class="n">normalize_trend</span><span class="p">,</span>
                <span class="n">debug_level</span><span class="o">=</span><span class="n">debug_level</span><span class="p">,</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="check_geogrid_parameters">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.check_geogrid_parameters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_geogrid_parameters</span><span class="p">(</span>
    <span class="n">project</span><span class="p">,</span> <span class="n">grid_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_names_geogrid_dict</span><span class="p">:</span> <span class="nb">dict</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">grid_model_name</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">grid_models</span><span class="p">:</span>
        <span class="n">grid_model</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">grid_models</span><span class="p">[</span><span class="n">grid_model_name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid model: </span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2"> does not exists.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">is_empty</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">current_realisation</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid model: </span><span class="si">{</span><span class="n">grid_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is empty.&quot;</span><span class="p">)</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">properties</span>
    <span class="n">continuous_type_param_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">discrete_type_param_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">zone_number</span><span class="p">,</span> <span class="n">property_names</span> <span class="ow">in</span> <span class="n">param_names_geogrid_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">continuous_type_param_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">property_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Grid parameter: </span><span class="si">{</span><span class="n">pname</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;does not exists for grid model: </span><span class="si">{</span><span class="n">grid_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">  &quot;</span>
                <span class="p">)</span>

            <span class="n">prop</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">is_empty</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">current_realisation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Grid property: </span><span class="si">{</span><span class="n">pname</span><span class="si">}</span><span class="s2"> is empty for grid model: </span><span class="si">{</span><span class="n">grid_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">rmsapi</span><span class="o">.</span><span class="n">GridPropertyType</span><span class="o">.</span><span class="n">continuous</span><span class="p">:</span>
                <span class="n">continuous_type_param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">prop</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">rmsapi</span><span class="o">.</span><span class="n">GridPropertyType</span><span class="o">.</span><span class="n">discrete</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">discrete_type_param_list</span><span class="p">:</span>
                    <span class="n">discrete_type_param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Grid parameter: </span><span class="si">{</span><span class="n">pname</span><span class="si">}</span><span class="s2"> for grid model: </span><span class="si">{</span><span class="n">grid_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;has type: </span><span class="si">{</span><span class="n">prop</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2"> which is not implemented in this script.&quot;</span>
                <span class="p">)</span>

        <span class="n">continuous_type_param_dict</span><span class="p">[</span><span class="n">zone_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">continuous_type_param_list</span>
    <span class="k">return</span> <span class="n">continuous_type_param_dict</span><span class="p">,</span> <span class="n">discrete_type_param_list</span></div>



<div class="viewcode-block" id="get_layer_range">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.get_layer_range">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_layer_range</span><span class="p">(</span><span class="n">indexer</span><span class="p">,</span> <span class="n">zone_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fmu_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="k">if</span> <span class="n">fmu_mode</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexer</span><span class="o">.</span><span class="n">zonation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">layer_ranges</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">zonation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;While in FMU / ERT mode, the grid must have EXACTLY 1 zone&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layer_ranges</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">zonation</span><span class="p">[</span>
            <span class="n">zone_number</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">]</span>  <span class="c1"># Zonation is 0-indexed, while zone numbers are 1-indexed</span>
    <span class="n">start_layer</span> <span class="o">=</span> <span class="n">nz</span>
    <span class="n">end_layer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">layer_range</span> <span class="ow">in</span> <span class="n">layer_ranges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start_layer</span> <span class="o">&gt;</span> <span class="n">layer_range</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="n">start_layer</span> <span class="o">=</span> <span class="n">layer_range</span><span class="o">.</span><span class="n">start</span>
        <span class="k">if</span> <span class="n">end_layer</span> <span class="o">&lt;</span> <span class="n">layer_range</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
            <span class="n">end_layer</span> <span class="o">=</span> <span class="n">layer_range</span><span class="o">.</span><span class="n">stop</span>
    <span class="k">return</span> <span class="n">end_layer</span><span class="p">,</span> <span class="n">start_layer</span></div>



<div class="viewcode-block" id="define_active_cell_indices">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.define_active_cell_indices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">define_active_cell_indices</span><span class="p">(</span>
    <span class="n">indexer</span><span class="p">,</span>
    <span class="n">cell_numbers</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">ijk_handedness</span><span class="p">,</span>
    <span class="n">use_left_handed_grid_indexing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">grid_model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span><span class="p">,</span>
    <span class="n">switch_handedness_for_parameters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="n">defined_cell_indices</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">get_indices</span><span class="p">(</span><span class="n">cell_numbers</span><span class="p">)</span>
    <span class="n">switch_handedness</span> <span class="o">=</span> <span class="n">switch_handedness_for_parameters</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ijk_handedness</span> <span class="o">==</span> <span class="n">Direction</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="ow">and</span> <span class="n">use_left_handed_grid_indexing</span><span class="p">:</span>
        <span class="n">switch_handedness</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">switch_handedness</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;-- Grid handedness for </span><span class="si">{</span><span class="n">grid_model_name</span><span class="si">}</span><span class="s2"> : &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ijk_handedness</span><span class="si">}</span><span class="s2">.  Switch handedness.&quot;</span>
            <span class="p">)</span>
        <span class="n">i_indices</span> <span class="o">=</span> <span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">j_indices</span> <span class="o">=</span> <span class="o">-</span><span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i_indices</span> <span class="o">=</span> <span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">j_indices</span> <span class="o">=</span> <span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">k_indices</span> <span class="o">=</span> <span class="n">defined_cell_indices</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">,</span> <span class="n">k_indices</span></div>



<div class="viewcode-block" id="set_continuous_3d_parameter_values_in_zone_region">
<a class="viewcode-back" href="../../../../fmu.tools.rms.html#fmu.tools.rms.copy_rms_param_to_ertbox_grid.set_continuous_3d_parameter_values_in_zone_region">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_continuous_3d_parameter_values_in_zone_region</span><span class="p">(</span>
    <span class="n">grid_model</span><span class="p">,</span>
    <span class="n">parameter_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">input_values_for_zones</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">zone_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">region_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">region_parameter_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">realisation_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">is_shared</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">debug_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEBUG_OFF</span><span class="p">,</span>
    <span class="n">fmu_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_left_handed_grid_indexing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">switch_handedness</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set 3D parameter with values for specified grid model for</span>
<span class="sd">       specified zone (and region)</span>

<span class="sd">    Input:</span>

<span class="sd">           grid_model:</span>
<span class="sd">                Grid model object</span>

<span class="sd">           parameter_names:</span>
<span class="sd">                List of names of 3D parameter to update.</span>

<span class="sd">           input_values_for_zones:</span>
<span class="sd">                A list of numpy 3D arrays.</span>
<span class="sd">                They corresponds to the parameter names in parameter_names.</span>
<span class="sd">                The size of the numpy input arrays are (nx,ny,nLayers) where</span>
<span class="sd">                nx, ny must match the gridModels 3D grid size for the simulation</span>
<span class="sd">                box grid and nLayers must match the number of layers for the</span>
<span class="sd">                zone in simulationx box. Note that since nx, ny are the simulation</span>
<span class="sd">                box grid size, they can be larger than the number of cells reported</span>
<span class="sd">                for the grid in reverse faulted grids. The grid values must be of type</span>
<span class="sd">                numpy.float32. Only the grid cells belonging to the specified zone</span>
<span class="sd">                are updated, and error is raised if the number of grid cells for</span>
<span class="sd">                the zone doesn&#39;t match the size of the input array.</span>

<span class="sd">           zone_number:</span>
<span class="sd">                The zone number (counted from 1 in the input)</span>

<span class="sd">           regionNumber:</span>
<span class="sd">                The region number for the grid cells to be updated.</span>

<span class="sd">           region_parameter_name:</span>
<span class="sd">                The name of the 3D grid parameter containing a discrete</span>
<span class="sd">                3D parameter with region numbers</span>

<span class="sd">           realisation_number:</span>
<span class="sd">                Realisation number counted from 0 for the parameter to get.</span>

<span class="sd">           is_shared:</span>
<span class="sd">                Is set to true or false if the parameter is to be set</span>
<span class="sd">                to shared or non-shared.</span>

<span class="sd">           debug_level: 0 is off, 1 or larger is on for additional output to screen</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if specified grid model exists and is not empty</span>
    <span class="k">if</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">is_empty</span><span class="p">(</span><span class="n">realisation_number</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Specified grid model: </span><span class="si">{</span><span class="n">grid_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;is empty for realisation </span><span class="si">{</span><span class="n">realisation_number</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check if the parameter is defined and create new if not existing</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="n">realisation_number</span><span class="p">)</span>

    <span class="c1"># Find grid layers for the zone</span>
    <span class="n">indexer</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">simbox_indexer</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ijk_handedness</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">ijk_handedness</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">ijk_handedness</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">handedness</span>

    <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="n">end_layer</span><span class="p">,</span> <span class="n">start_layer</span> <span class="o">=</span> <span class="n">get_layer_range</span><span class="p">(</span><span class="n">indexer</span><span class="p">,</span> <span class="n">zone_number</span><span class="p">,</span> <span class="n">fmu_mode</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start_layer</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">end_layer</span><span class="p">)</span>
    <span class="n">zone_cell_numbers</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">get_cell_numbers_in_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="n">num_layers</span> <span class="o">=</span> <span class="n">end_layer</span> <span class="o">-</span> <span class="n">start_layer</span>
    <span class="c1"># All input data vectors are from the same zone and has the same size</span>
    <span class="n">nx_in</span><span class="p">,</span> <span class="n">ny_in</span><span class="p">,</span> <span class="n">nz_in</span> <span class="o">=</span> <span class="n">input_values_for_zones</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">nx</span> <span class="o">!=</span> <span class="n">nx_in</span> <span class="ow">or</span> <span class="n">ny</span> <span class="o">!=</span> <span class="n">ny_in</span> <span class="ow">or</span> <span class="n">num_layers</span> <span class="o">&gt;</span> <span class="n">nz_in</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
            <span class="s2">&quot;Input array with values has different dimensions than the grid model:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Grid model nx: </span><span class="si">{</span><span class="n">nx</span><span class="si">}</span><span class="s2">  Input array nx: </span><span class="si">{</span><span class="n">nx_in</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Grid model ny: </span><span class="si">{</span><span class="n">ny</span><span class="si">}</span><span class="s2">  Input array ny: </span><span class="si">{</span><span class="n">ny_in</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Grid model nLayers for zone </span><span class="si">{</span><span class="n">zone_number</span><span class="si">}</span><span class="s2"> is: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_layers</span><span class="si">}</span><span class="s2">    Input array nz: </span><span class="si">{</span><span class="n">nz_in</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">use_regions</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">region_parameter_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">region_parameter_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">fmu_mode</span><span class="p">:</span>
        <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">,</span> <span class="n">k_indices</span> <span class="o">=</span> <span class="n">define_active_cell_indices</span><span class="p">(</span>
            <span class="n">indexer</span><span class="p">,</span>
            <span class="n">zone_cell_numbers</span><span class="p">,</span>
            <span class="n">ijk_handedness</span><span class="p">,</span>
            <span class="n">use_left_handed_grid_indexing</span><span class="p">,</span>
            <span class="n">grid_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">debug_level</span><span class="o">=</span><span class="n">DEBUG_OFF</span><span class="p">,</span>
            <span class="n">switch_handedness_for_parameters</span><span class="o">=</span><span class="n">switch_handedness</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get region parameter values</span>
        <span class="k">if</span> <span class="n">region_parameter_name</span> <span class="ow">in</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">region_parameter_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_empty</span><span class="p">(</span><span class="n">realisation_number</span><span class="p">):</span>
                <span class="n">region_param_values</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">realisation_number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">region_parameter_name</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;does not exist or is empty in grid model </span><span class="si">{</span><span class="n">grid_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">region_param_values_in_zone</span> <span class="o">=</span> <span class="n">region_param_values</span><span class="p">[</span><span class="n">zone_cell_numbers</span><span class="p">]</span>
        <span class="n">zone_region_cell_numbers</span> <span class="o">=</span> <span class="n">zone_cell_numbers</span><span class="p">[</span>
            <span class="n">region_param_values_in_zone</span> <span class="o">==</span> <span class="n">region_number</span>
        <span class="p">]</span>
        <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">,</span> <span class="n">k_indices</span> <span class="o">=</span> <span class="n">define_active_cell_indices</span><span class="p">(</span>
            <span class="n">indexer</span><span class="p">,</span>
            <span class="n">zone_region_cell_numbers</span><span class="p">,</span>
            <span class="n">ijk_handedness</span><span class="p">,</span>
            <span class="n">use_left_handed_grid_indexing</span><span class="p">,</span>
            <span class="n">grid_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">debug_level</span><span class="o">=</span><span class="n">DEBUG_OFF</span><span class="p">,</span>
            <span class="n">switch_handedness_for_parameters</span><span class="o">=</span><span class="n">switch_handedness</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">use_regions</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Loop over all parameter names</span>
    <span class="k">for</span> <span class="n">param_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">)):</span>
        <span class="n">parameter_name</span> <span class="o">=</span> <span class="n">parameter_names</span><span class="p">[</span><span class="n">param_index</span><span class="p">]</span>
        <span class="n">input_values_for_zone</span> <span class="o">=</span> <span class="n">input_values_for_zones</span><span class="p">[</span><span class="n">param_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parameter_name</span> <span class="ow">in</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="n">property_param</span> <span class="o">=</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create new parameter</span>
            <span class="n">property_param</span> <span class="o">=</span> <span class="n">grid_model</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">parameter_name</span><span class="p">,</span> <span class="n">rmsapi</span><span class="o">.</span><span class="n">GridPropertyType</span><span class="o">.</span><span class="n">continuous</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
            <span class="p">)</span>
            <span class="n">property_param</span><span class="o">.</span><span class="n">set_shared</span><span class="p">(</span><span class="n">is_shared</span><span class="p">,</span> <span class="n">realisation_number</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="n">DEBUG_VERY_VERBOSE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Create specified RMS parameter: </span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_shared</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Set parameter to shared.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Set parameter to non-shared.&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">property_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">property_param</span><span class="o">.</span><span class="n">is_empty</span><span class="p">(</span><span class="n">realisation_number</span><span class="p">):</span>
            <span class="c1"># Initialize to 0 if empty</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">property_param</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">realisation_number</span><span class="p">)</span>

        <span class="c1"># Get current values</span>
        <span class="n">current_values</span> <span class="o">=</span> <span class="n">property_param</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">realisation_number</span><span class="p">)</span>

        <span class="c1"># Assign values from input array into the 3D grid array</span>
        <span class="c1"># Note that input array is of dimension (nx,ny,nLayers)</span>
        <span class="c1"># where nLayers is the number of layers of the input grid</span>
        <span class="c1"># These layers must correspond to layer from start_layer</span>
        <span class="c1"># until but not including end_layer in the full 3D grid.</span>

        <span class="c1"># Create a 3D array for all cells in the grid including inactive cells</span>
        <span class="c1"># Since the cell numbers, and the indices all are based on the same range,</span>
        <span class="c1"># it is possible to use numpy vectorization to copy</span>
        <span class="n">new_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_layer</span><span class="p">,</span> <span class="n">end_layer</span><span class="p">):</span>
            <span class="n">new_values</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_values_for_zone</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span> <span class="o">-</span> <span class="n">start_layer</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_regions</span><span class="p">:</span>
            <span class="n">current_values</span><span class="p">[</span><span class="n">zone_region_cell_numbers</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_values</span><span class="p">[</span>
                <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">,</span> <span class="n">k_indices</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_values</span><span class="p">[</span><span class="n">zone_cell_numbers</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_values</span><span class="p">[</span>
                <span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">,</span> <span class="n">k_indices</span>
            <span class="p">]</span>

        <span class="n">property_param</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">current_values</span><span class="p">,</span> <span class="n">realisation_number</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Equinor.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #ff1243;
    }
    /* Sidebar */
    .wy-nav-side {
      background: #474747;
    }
    .wy-side-nav-search > div.version {
      color: white;
    }
  </style>


</body>
</html>